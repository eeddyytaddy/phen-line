# ------------------------------------------------------------
# 1. 基礎映像
# ------------------------------------------------------------
FROM python:3.11.9-slim

# 2. 建立非 root 使用者（保留，但不切換）
RUN useradd -m appuser

# ------------------------------------------------------------
# 3. 安裝系統套件
# ------------------------------------------------------------
RUN apt-get update && apt-get install -y \
    build-essential libssl-dev libffi-dev python3-dev \
    git sqlite3 fontconfig fonts-noto-cjk \
    && rm -rf /var/lib/apt/lists/*

# ------------------------------------------------------------
# 4. 設定工作目錄
# ------------------------------------------------------------
WORKDIR /usr/src/app

# ------------------------------------------------------------
# 5. 安裝 Python 依賴
# ------------------------------------------------------------
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# ------------------------------------------------------------
# 6. 複製程式碼
# ------------------------------------------------------------
COPY . .

# ------------------------------------------------------------
# 7. 初始化 SQLite（若已存在則忽略錯誤）
# ------------------------------------------------------------
RUN python init_db.py || true

# ------------------------------------------------------------
# 8. 環境變數
# ------------------------------------------------------------
ENV APP_ENV=docker \
    PORT=10000 \
    PYTHONUNBUFFERED=1

# ------------------------------------------------------------
# 9. 對外開放埠（Railway 會自動映射）
# ------------------------------------------------------------
EXPOSE 10000

# ------------------------------------------------------------
# 10. 預設啟動指令
#     *phen-line* 會覆蓋為 gunicorn
#     *locust-runner* 會覆蓋為 locust
# ------------------------------------------------------------
CMD ["sleep", "infinity"]
RUN pip install --no-cache-dir locust==2.27.1 


