############################################################
# 1. 基礎映像
############################################################
FROM python:3.11.9-slim

############################################################
# 2. 決定最終使用者
#    build-arg FINAL_USER=root   → root
#    build-arg FINAL_USER=appuser (預設) → appuser
############################################################
ARG FINAL_USER=appuser

# 建立非 root 使用者供選擇
RUN useradd -m appuser

############################################################
# 3. 安裝系統套件、依賴 & 複製程式碼（略，同之前）
############################################################
# …（保持你原來的安裝 / COPY / init_db 指令）…

############################################################
# 4. 若最終要用 appuser，先把檔案歸屬權調整一下
RUN if [ "$FINAL_USER" = "appuser" ]; then \
      chown -R appuser:appuser /usr/src/app; \
    fi

############################################################
# 5. 最後一行 USER 決定真正執行身分
############################################################
USER ${FINAL_USER}

# 預設 CMD 會被 Railway 的 Start Command 覆蓋
CMD ["sleep", "infinity"]
