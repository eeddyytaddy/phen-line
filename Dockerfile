#######################################################################
# 1. 基礎映像
#######################################################################
FROM python:3.11.9-slim

#######################################################################
# 2. 參數：決定最終使用者
#    - 不傳或 FINAL_USER=appuser  → 以 appuser 執行（安全，用於 Web）
#    - FINAL_USER=root           → 以 root   執行（可寫 Volume，給 Locust）
#######################################################################
ARG FINAL_USER=appuser

#######################################################################
# 3. 建立非 root 使用者（供 FINAL_USER=appuser 時使用）
#######################################################################
RUN useradd -m appuser

#######################################################################
# 4. 安裝必要系統套件
#######################################################################
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        build-essential \
        git \
        sqlite3 \
        libssl-dev libffi-dev python3-dev \
        fontconfig fonts-noto-cjk \
    && rm -rf /var/lib/apt/lists/*

#######################################################################
# 5. 設定工作目錄
#######################################################################
WORKDIR /usr/src/app

#######################################################################
# 6. 安裝 Python 相依
#######################################################################
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

#######################################################################
# 7. 複製應用程式碼
#######################################################################
COPY . .

#######################################################################
# 8. 初始化 SQLite（若已存在則忽略錯誤）
#######################################################################
RUN python init_db.py || true

#######################################################################
# 9. 若最終使用者是 appuser，就調整檔案權限
#######################################################################
RUN if [ "$FINAL_USER" = "appuser" ]; then \
        chown -R appuser:appuser /usr/src/app; \
    fi

#######################################################################
# 10. 切換到最終使用者
#######################################################################
USER ${FINAL_USER}

#######################################################################
# 11. 預設 CMD（會被 Railway 的 Custom Start Command 覆蓋）
#######################################################################
CMD ["sleep", "infinity"]
